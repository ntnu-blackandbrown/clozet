<!DOCTYPE html>
<html>
<head>
    <title>WebSocket STOMP Client</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #log { height: 400px; border: 1px solid #ccc; padding: 10px; overflow-y: scroll; background-color: #f5f5f5; }
        .controls { margin-top: 20px; }
        button { padding: 8px 15px; margin-right: 10px; cursor: pointer; }
        input, textarea { padding: 8px; margin-bottom: 10px; width: 100%; box-sizing: border-box; }
        .form-group { margin-bottom: 15px; }
        .message-received { color: green; }
        .message-sent { color: blue; }
        .error { color: red; }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { color: #333; }
        #connection-status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .connected {
            background-color: #dff0d8;
            color: #3c763d;
            border: 1px solid #d6e9c6;
        }
        .disconnected {
            background-color: #f2dede;
            color: #a94442;
            border: 1px solid #ebccd1;
        }
        .connecting {
            background-color: #fcf8e3;
            color: #8a6d3b;
            border: 1px solid #faebcc;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>WebSocket Message Tester</h1>
    <div id="connection-status" class="disconnected">Status: Disconnected</div>
    <div class="connection-info">
        <div class="form-group">
            <label>Server URL:</label>
            <input id="serverUrl" value="http://localhost:8080/ws" />
            <p><small>Use HTTP/HTTPS URL, not WebSocket (ws) directly</small></p>
        </div>
        <div>
            <button id="connect">Connect</button>
            <button id="disconnect" disabled>Disconnect</button>
            <button id="checkConnection">Check Connection</button>
        </div>
    </div>

    <h2>Messages</h2>
    <div id="log"></div>

    <div class="controls">
        <h3>Send Message</h3>
        <div class="form-group">
            <label>Sender ID:</label>
            <input id="sender" placeholder="Sender ID" value="buyer1" />
        </div>
        <div class="form-group">
            <label>Receiver ID:</label>
            <input id="receiver" placeholder="Receiver ID" value="seller1" />
        </div>
        <div class="form-group">
            <label>Message:</label>
            <textarea id="message" placeholder="Write message here"></textarea>
        </div>
        <button id="send" disabled>Send Message</button>
        <button id="ping" disabled>Ping Server</button>
    </div>
</div>

<script>
    let stompClient = null;
    let connected = false;
    let messageCount = 0;
    const logElement = document.getElementById('log');
    const connectionStatus = document.getElementById('connection-status');

    function updateConnectionStatus(status, message) {
        connectionStatus.className = status;
        connectionStatus.textContent = `Status: ${message}`;
    }

    function log(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const msgDiv = document.createElement('div');
        msgDiv.className = type;
        msgDiv.innerHTML = `[${timestamp}] ${message}`;
        logElement.appendChild(msgDiv);
        logElement.scrollTop = logElement.scrollHeight;
    }

    function connect() {
        const serverUrl = document.getElementById('serverUrl').value;
        updateConnectionStatus('connecting', 'Connecting...');
        log(`Attempting to connect to ${serverUrl}...`);

        try {
            const socket = new SockJS(serverUrl);
            stompClient = Stomp.over(socket);

            // Enable STOMP debug logging
            stompClient.debug = function(str) {
                console.log(str);
                log(`STOMP Debug: ${str}`, 'info');
            };

            stompClient.connect({},
                function(frame) { // Success callback
                    connected = true;
                    updateConnectionStatus('connected', 'Connected');
                    log(`Connected successfully: ${frame}`, 'message-received');
                    
                    document.getElementById('connect').disabled = true;
                    document.getElementById('disconnect').disabled = false;
                    document.getElementById('send').disabled = false;
                    document.getElementById('ping').disabled = false;

                    // Subscribe to various topics
                    subscribeToTopics();
                },
                function(error) { // Error callback
                    connected = false;
                    updateConnectionStatus('disconnected', 'Connection Failed');
                    log(`Connection error: ${error}`, 'error');
                    resetButtons();
                }
            );

            // Add connection heartbeat
            stompClient.heartbeat.outgoing = 20000; // Send heartbeat every 20 seconds
            stompClient.heartbeat.incoming = 20000; // Expect heartbeat every 20 seconds

        } catch (e) {
            log(`Connection error: ${e.message}`, 'error');
            updateConnectionStatus('disconnected', 'Connection Error');
            console.error(e);
            resetButtons();
        }
    }

    function subscribeToTopics() {
        // Subscribe to main message topic
        stompClient.subscribe('/topic/messages', function(messageOutput) {
            try {
                const message = JSON.parse(messageOutput.body);
                messageCount++;
                log(`Received message #${messageCount}:<br>
                    ID: ${message.id}<br>
                    From: ${message.senderId}<br>
                    To: ${message.receiverId}<br>
                    Content: ${message.content}<br>
                    Time: ${message.createdAt}`, 'message-received');
            } catch (e) {
                log(`Error parsing message: ${e.message}`, 'error');
                console.error("Raw message:", messageOutput.body);
            }
        });

        // Subscribe to read status updates
        stompClient.subscribe('/topic/messages.read', function(messageOutput) {
            try {
                const message = JSON.parse(messageOutput.body);
                log(`Message marked as read:<br>
                    ID: ${message.id}<br>
                    Read: ${message.read}`, 'message-received');
            } catch (e) {
                log(`Error parsing read status: ${e.message}`, 'error');
            }
        });

        // Subscribe to message updates
        stompClient.subscribe('/topic/messages.update', function(messageOutput) {
            try {
                const message = JSON.parse(messageOutput.body);
                log(`Message updated:<br>
                    ID: ${message.id}<br>
                    Content: ${message.content}`, 'message-received');
            } catch (e) {
                log(`Error parsing update: ${e.message}`, 'error');
            }
        });
    }

    function disconnect() {
        if (stompClient && connected) {
            try {
                stompClient.disconnect(function() {
                    log('Disconnected from WebSocket server');
                    updateConnectionStatus('disconnected', 'Disconnected');
                    resetButtons();
                });
            } catch (e) {
                log(`Disconnect error: ${e.message}`, 'error');
            }
        }
        connected = false;
    }

    function resetButtons() {
        connected = false;
        document.getElementById('connect').disabled = false;
        document.getElementById('disconnect').disabled = true;
        document.getElementById('send').disabled = true;
        document.getElementById('ping').disabled = true;
    }

    function sendMessage() {
        if (!connected || !stompClient) {
            log('Not connected. Please connect first.', 'error');
            return;
        }

        const sender = document.getElementById('sender').value;
        const receiver = document.getElementById('receiver').value;
        const content = document.getElementById('message').value;

        if (!content || !sender || !receiver) {
            log('Please fill in all fields', 'error');
            return;
        }

        const message = {
            senderId: sender,
            receiverId: receiver,
            content: content,
            createdAt: new Date().toISOString()
        };

        try {
            log(`Sending message:<br>
                From: ${message.senderId}<br>
                To: ${message.receiverId}<br>
                Content: ${message.content}`, 'message-sent');

            stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(message));
            document.getElementById('message').value = '';
        } catch (e) {
            log(`Send error: ${e.message}`, 'error');
            console.error(e);
        }
    }

    function pingServer() {
        if (!connected || !stompClient) {
            log('Not connected. Please connect first.', 'error');
            return;
        }

        try {
            stompClient.send("/app/chat.ping", {}, "");
            log('Ping sent to server', 'message-sent');
        } catch (e) {
            log(`Ping error: ${e.message}`, 'error');
        }
    }

    function checkConnection() {
        if (stompClient && connected) {
            try {
                stompClient.send("/app/chat.ping", {}, "");
                log('Connection check: Active', 'message-received');
            } catch (e) {
                log('Connection check: Failed', 'error');
                resetButtons();
                updateConnectionStatus('disconnected', 'Connection Lost');
            }
        } else {
            log('Connection check: Not connected', 'error');
            resetButtons();
            updateConnectionStatus('disconnected', 'Not Connected');
        }
    }

    // Event Listeners
    document.getElementById('connect').addEventListener('click', connect);
    document.getElementById('disconnect').addEventListener('click', disconnect);
    document.getElementById('send').addEventListener('click', sendMessage);
    document.getElementById('ping').addEventListener('click', pingServer);
    document.getElementById('checkConnection').addEventListener('click', checkConnection);

    document.getElementById('message').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (!document.getElementById('send').disabled) {
                sendMessage();
            }
        }
    });

    // Global error handler
    window.onerror = function(message, source, lineno, colno, error) {
        log(`Global error: ${message}`, 'error');
        return false;
    };
</script>
</body>
</html>